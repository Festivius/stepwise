<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stepwise Studio - Dance Video Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Comfortaa:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
      }

      body {
        background: #f5f1e8;
        color: #374151;
        min-height: 100vh;
        padding: 70px;
        padding-top: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* STARTUP LOADING SCREEN */
      .startup-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #f5f1e8 0%, #ede0d4 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
      }

      .startup-loading.hidden {
        opacity: 0;
        visibility: hidden;
      }

      .startup-logo {
        width: 120px;
        height: 120px;
        margin-bottom: 30px;
        filter: drop-shadow(0 4px 20px rgba(138, 122, 109, 0.3));
        animation: gentle-float 3s ease-in-out infinite;
      }

      @keyframes gentle-float {
        0%, 100% { 
          transform: translateY(0) rotate(0deg) scale(1); 
        }
        25% { 
          transform: translateY(-8px) rotate(-3deg) scale(1.05); 
        }
        50% { 
          transform: translateY(-12px) rotate(0deg) scale(1.1); 
        }
        75% { 
          transform: translateY(-8px) rotate(3deg) scale(1.05); 
        }
      }

      .startup-title {
        font-size: 3rem;
        font-weight: 600;
        font-family: 'Comfortaa', cursive;
        color: #8a7a6d;
        letter-spacing: 1px;
        text-shadow: 0 3px 8px rgba(138, 122, 109, 0.2);
        margin-bottom: 10px;
        animation: fade-in-up 1s ease-out 0.5s both;
      }

      .startup-tagline {
        color: #8a9b6e;
        font-size: 1.2rem;
        font-weight: 500;
        letter-spacing: 2px;
        margin-bottom: 40px;
        animation: fade-in-up 1s ease-out 0.7s both;
      }

      .startup-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(138, 155, 110, 0.2);
        border-top: 4px solid #8a9b6e;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        margin-bottom: 20px;
      }

      .startup-status {
        color: #6b7280;
        font-size: 1rem;
        font-weight: 400;
        animation: fade-in-up 1s ease-out 0.9s both;
      }

      @keyframes fade-in-up {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* VIDEO DOWNLOAD LOADING OVERLAY */
      .video-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(245, 241, 232, 0.95);
        backdrop-filter: blur(10px);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        border-radius: 20px;
        transition: all 0.3s ease;
      }

      .video-loading-overlay.visible {
        display: flex;
      }

      .download-dancer {
        width: 80px;
        height: 80px;
        margin-bottom: 25px;
        filter: drop-shadow(0 3px 15px rgba(138, 155, 110, 0.3));
        animation: dance-loading 2s ease-in-out infinite;
      }

      @keyframes dance-loading {
        0%, 100% { 
          transform: translateY(0) rotate(0deg) scale(1); 
        }
        25% { 
          transform: translateY(-10px) rotate(-5deg) scale(1.1); 
        }
        50% { 
          transform: translateY(-5px) rotate(5deg) scale(0.95); 
        }
        75% { 
          transform: translateY(-15px) rotate(-3deg) scale(1.05); 
        }
      }

      .download-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #8a7a6d;
        margin-bottom: 10px;
        text-align: center;
        font-family: 'Comfortaa', cursive;
      }

      .download-subtitle {
        color: #6b7280;
        font-size: 1rem;
        margin-bottom: 30px;
        text-align: center;
        max-width: 300px;
      }

      /* PROGRESS BAR */
      .progress-wrapper {
        width: 300px;
        margin-bottom: 20px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(138, 155, 110, 0.2);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #8a9b6e 0%, #b8b09c 50%, #8a9b6e 100%);
        border-radius: 10px;
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
        box-shadow: 0 2px 8px rgba(138, 155, 110, 0.4);
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      .progress-text {
        text-align: center;
        margin-top: 10px;
        font-size: 0.9rem;
        color: #8a9b6e;
        font-weight: 500;
        font-family: monospace;
      }

      .download-tips {
        text-align: center;
        font-size: 0.8rem;
        color: #9ca3af;
        max-width: 280px;
        line-height: 1.4;
      }

      /* PULSING DOTS ANIMATION */
      .loading-dots {
        display: inline-flex;
        gap: 4px;
        margin-left: 8px;
      }

      .loading-dots span {
        width: 6px;
        height: 6px;
        background: #8a9b6e;
        border-radius: 50%;
        animation: pulse-dot 1.4s infinite ease-in-out;
      }

      .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
      .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
      .loading-dots span:nth-child(3) { animation-delay: 0s; }

      @keyframes pulse-dot {
        0%, 80%, 100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .header {
        text-align: left;
        margin-bottom: 20px;
        width: 100%;
        max-width: 1400px;
        padding-left: 25px;
        padding-bottom: 5px;
        padding-top: 10px;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .header-content {
        flex: 1;
      }

      .header h1 {
        font-size: 2.2rem;
        font-weight: 600;
        font-family: 'Comfortaa', cursive;
        color: #8a7a6d; /* Darker beige */
        letter-spacing: 0.5px;
        margin: 0 0 8px 0;
        text-shadow: 0 2px 4px rgba(138, 122, 109, 0.1);
      }

      .header .tagline {
        color: #6b7280;
        font-size: 1rem;
        margin: 0;
        font-weight: 400;
        font-family: 'Poppins', sans-serif;
        letter-spacing: 1px;
      }

      .header-icon {
        width: 80px;
        height: 80px;
        flex-shrink: 0;
        filter: drop-shadow(0 2px 8px rgba(138, 122, 109, 0.2));
        animation: gentle-dance 3s ease-in-out infinite;
        object-fit: contain;
      }

      @keyframes gentle-dance {
        0%, 100% { 
          transform: translateY(0) rotate(0deg); 
        }
        25% { 
          transform: translateY(-3px) rotate(-2deg); 
        }
        50% { 
          transform: translateY(-6px) rotate(0deg); 
        }
        75% { 
          transform: translateY(-3px) rotate(2deg); 
        }
      }

      @media (max-width: 768px) {
        .header {
          margin-bottom: 20px;
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }
        
        .header-icon {
          width: 60px;
          height: 60px;
        }
        
        .header h1 {
          font-size: 1.8rem;
        }
        
        .header .tagline {
          font-size: 0.9rem;
        }

        .startup-title {
          font-size: 2.2rem;
        }

        .progress-wrapper {
          width: 250px;
        }

        .download-dancer {
          width: 60px;
          height: 60px;
        }
      }

      .logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .logo-icon {
        font-size: 2rem;
        color: #8a9b6e; /* Desaturated green */
        animation: bounce 2s infinite;
        filter: drop-shadow(0 2px 4px rgba(138, 155, 110, 0.2)); /* Updated shadow */
      }

      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-8px); }
        60% { transform: translateY(-4px); }
      }

      h1 {
        font-size: 2.2rem;
        font-weight: 600;
        font-family: 'Comfortaa', cursive;
        color: #8a9b6e; /* Desaturated green */
        letter-spacing: 0.5px;
        text-shadow: 0 2px 4px rgba(138, 155, 110, 0.1); /* Updated shadow */
      }

      .tagline {
        color: #6b7280;
        font-size: 1rem;
        margin-top: 4px;
        font-weight: 400;
        max-width: 500px;
        margin: 4px auto 0;
        line-height: 1.4;
      }

      .container {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 1400px;
        gap: 30px;
      }

      .search-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(138, 155, 110, 0.1); /* Updated shadow */
        border: 2px solid #f0ece4; /* Beige border */
      }

      .search-container {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        position: relative;
      }

      #searchQuery {
        flex: 1;
        padding: 16px 25px;
        border-radius: 25px;
        border: 2px solid #ede0d4;
        background: #faf8f5;
        color: #374151;
        font-size: 1.1rem;
        outline: none;
        transition: all 0.3s ease;
      }

      #searchQuery:focus {
        border-color: #d1cbce;
        background: white;
        box-shadow: 0 0 0 3px rgba(138, 155, 110, 0.1); /* Updated shadow */
      }

      #searchBtn {
        background: #d8d1b9; /* Beige */
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0 35px;
        font-size: 1.1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(138, 155, 110, 0.2); /* Updated shadow */
      }

      #searchBtn:hover {
        background: #b8b09c; /* Darker beige */
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(138, 155, 110, 0.3); /* Updated shadow */
      }

      #results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 25px;
        margin-top: 25px;
      }

      .video-item {
        cursor: pointer;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 2px solid #f0ece4; /* Beige border */
        position: relative;
        box-shadow: 0 2px 10px rgba(138, 155, 110, 0.1); /* Updated shadow */
      }

      .video-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(138, 155, 110, 0.2); /* Updated shadow */
        border-color: #8a9b6e; /* Desaturated green */
      }

      .video-item img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        display: block;
      }

      .video-item strong {
        display: block;
        padding: 15px;
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.4;
        color: #374151;
      }

      .save-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: #8a9b6e; /* Desaturated green */
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .save-btn:hover {
        background: #8a9b6e; /* Desaturated green */
        color: white;
        transform: scale(1.1);
      }

      .save-btn.saved {
        color: #e8ebdf;
        background: white;
      }

      .player-container {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
      }

      .player-section {
        flex: 1;
        min-width: 300px;
      }

      .video-container {
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        background: #1f2937;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        aspect-ratio: 16/9;
        border: 3px solid #f0ece4; /* Beige border */
      }

      #videoPlayer {
        width: 100%;
        height: 100%;
        display: block;
        outline: none;
        cursor: pointer;
      }

      .mirror-video {
        transform: scaleX(-1);
      }

      #videoTitle {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        font-size: 1.3rem;
        font-weight: 500;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        z-index: 10;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        max-width: calc(100% - 40px);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .controls-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 80px 20px 20px 20px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 20;
      }

      .video-container:hover .controls-overlay,
      .video-container:hover #videoTitle,
      .video-container:focus-within .controls-overlay,
      .video-container:focus-within #videoTitle {
        opacity: 1;
      }

      /* NEW: Progress container for bar and handles */
      .progress-container {
        position: absolute;
        bottom: 60px;
        left: 20px;
        right: 20px;
        height: 30px;
        cursor: pointer;
        z-index: 30;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
      }
      
      .playback-bar {
        height: 5px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        width: 100%;
        position: relative;
        transition: height 0.2s ease;
      }

      .progress-container:hover .playback-bar {
        height: 8px;
      }

      .playback-progress {
        height: 100%;
        background: #8a9b6e; /* Desaturated green */
        border-radius: 3px;
        width: 0%;
        position: relative;
        transition: width 0.1s;
      }

      .playback-thumb {
        position: absolute;
        top: 50%;
        right: 0;
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        transform: translate(50%, -50%);
        opacity: 0;
        transition: opacity 0.2s;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      }

      .progress-container:hover .playback-thumb {
        opacity: 1;
      }

      .loop-range {
        position: absolute;
        height: 100%;
        background: rgba(138, 155, 110, 0.3); /* Desaturated green */
        border-radius: 3px;
        z-index: -1;
        box-shadow: 0 0 5px rgba(138, 155, 110, 0.3); /* Updated shadow */
      }

      /* UPDATED: Loop handle positioning */
      .loop-handle {
        position: absolute;
        top: 0;
        width: 6px;
        height: 30px;
        background: #8a9b6e;
        border-radius: 3px;
        transform: translateX(-50%);
        cursor: ew-resize;
        z-index: 40;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s;
      }

      .loop-handle:hover {
        width: 8px;
        background: #7a8b5e; /* Darker desaturated green */
      }

      .controls-bar {
        display: flex;
        align-items: center;
        gap: 15px;
        padding-top: 15px;
      }

      .control-btn {
        position: relative;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
      }

      .control-btn.active {
        color: #8a9b6e; /* Desaturated green */
      }

      .time-display {
        font-size: 0.95rem;
        color: #ddd;
        font-family: monospace;
        margin: 0 5px;
      }

      .controls-spacer {
        flex: 1;
      }

      .speed-control {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.2s;
      }

      .speed-control:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .pause-animation {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%);
        width: 80px;
        height: 80px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        z-index: 15;
        transition: opacity 0.3s;
      }

      .pause-animation i {
        font-size: 40px;
        color: white;
      }

      .pause-animation.visible {
        opacity: 1;
        animation: fadeOut 0.8s forwards;
      }

      @keyframes fadeOut {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1.5);
        }
      }

      .skip-animation {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 80px;
        height: 80px;
        display: none;
        z-index: 35;
        pointer-events: none;
        opacity: 0;
        animation: none;
      }

      .skip-animation.visible {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
        animation: skipPulse 0.8s ease-out forwards;
      }

      .skip-animation-icon {
        font-size: 24px;
        color: white;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        text-shadow: 0 0 10px rgba(0,0,0,0.7);
      }

      .skip-animation-circle {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(138, 155, 110, 0.4); /* Desaturated green */
        animation: skipCircle 0.8s ease-out forwards;
        z-index: 1;
      }

      @keyframes skipPulse {
        0% {
          transform: translateY(-50%) scale(0.5);
          opacity: 0;
        }
        30% {
          opacity: 1;
        }
        100% {
          transform: translateY(-50%) scale(1.5);
          opacity: 0;
        }
      }

      @keyframes skipCircle {
        0% {
          transform: scale(0.8);
          opacity: 0.8;
        }
        100% {
          transform: scale(1.8);
          opacity: 0;
        }
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .volume-slider-container {
        width: 0;
        overflow: hidden;
        transition: width 0.3s ease;
        height: 30px;
        display: flex;
        align-items: center;
      }

      .volume-control:hover .volume-slider-container {
        width: 80px;
      }

      #volumeSlider {
        width: 80px;
        height: 5px;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
        outline: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .volume-control:hover #volumeSlider {
        opacity: 1;
      }

      #volumeSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
      }

      #volumeSlider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      .fullscreen .video-container {
        position: fixed;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 1000;
        border-radius: 0 !important;
        border: none !important; /* This removes any border */
        margin: 0 !important;
        padding: 0 !important;
        background: #000 !important; /* Ensures black background */
      }

      .fullscreen .controls-overlay {
        padding: 60px 20px 20px 20px;
      }

      .fullscreen .progress-container {
        bottom: 70px;
      }

      .fullscreen .header,
      .fullscreen .search-section,
      .fullscreen .feature-controls {
        display: none;
      }

      .loop-indicator {
        position: absolute;
        bottom: 40px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: #8a9b6e; /* Desaturated green */
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 25;
        display: none;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      }

      .loop-indicator i {
        margin-right: 5px;
      }

      .loop-highlight.active {
        opacity: 1;
        animation: pulseHighlight 2s infinite;
      }

      @keyframes pulseHighlight {
        0% { background: rgba(138, 155, 110, 0.1); } /* Desaturated green */
        50% { background: rgba(138, 155, 110, 0.2); } /* Desaturated green */
        100% { background: rgba(138, 155, 110, 0.1); } /* Desaturated green */
      }

      .tooltip {
        position: absolute;
        top: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      }

      .control-btn-container:hover .tooltip,
      .loop-handle:hover .tooltip {
        opacity: 1;
      }

      .control-btn-container {
        position: relative;
        display: inline-block;
      }

      .loop-handle {
        position: relative;
      }

      #playPauseBtn-container .tooltip,
      #fullscreenBtn-container .tooltip {
        top: auto;
        bottom: 100%;
        margin-bottom: 8px;
      }

      .saved-section {
        width: 320px;
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(138, 155, 110, 0.1); /* Updated shadow */
        border: 2px solid #f0ece4; /* Beige border */
        max-height: 600px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .saved-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0ece4; /* Beige border */
        gap: 15px;
      }

      .saved-title {
        font-size: 1.3rem;
        font-weight: 600;
        font-family: 'Comfortaa', cursive;
        color: #8a7a6d; /* Darker beige */
        flex: 1;
        text-align: left;
      }

      .clear-saved {
        background: #f0ece4; /* Beige */
        border: none;
        color: #6b5d51; /* Darker beige */
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.3s;
        flex-shrink: 0;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .clear-all-icon {
        font-size: 0.7rem;
      }

      .clear-saved:hover {
        background: #8a9b6e; /* Desaturated green */
        color: white;
        transform: scale(1.05);
      }

      .saved-videos-container {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
      }

      .saved-video {
        display: flex;
        align-items: center;
        background: #faf8f5;
        border-radius: 16px;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s;
        border: 2px solid #ede0d4;
      }

      .saved-video:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(138, 155, 110, 0.1); /* Updated shadow */
        border-color: #8a9b6e; /* Desaturated green */
      }

      .saved-thumb {
        width: 80px;
        height: 60px;
        object-fit: cover;
        flex-shrink: 0;
        border-radius: 12px;
        margin: 8px;
      }

      .saved-details {
        flex: 1;
        padding: 10px 15px;
        overflow: hidden;
      }

      .saved-video-title {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 5px;
        color: #374151;
      }

      .saved-actions {
        display: flex;
        gap: 10px;
        padding: 0 10px;
      }

      .saved-btn {
        background: #f0ece4; /* Beige */
        border: none;
        color: #8a9b6e; /* Desaturated green */
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .saved-btn:hover {
        background: #8a9b6e; /* Desaturated green */
        color: white;
        transform: scale(1.1);
      }

      .empty-saved {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 30px 0;
        color: #9ca3af;
      }

      .empty-saved i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #e8ebdf; /* Light desaturated green */
      }

      @media (max-width: 1200px) {
        .player-container {
          flex-direction: column;
        }
        
        .saved-section {
          width: 100%;
          max-height: 300px;
        }
      }

      @media (max-width: 768px) {
        .header {
          margin-bottom: 20px;
        }
        
        h1 {
          font-size: 2.2rem;
        }
        
        .logo {
          flex-direction: column;
          gap: 5px;
        }
        
        .search-container {
          flex-direction: column;
        }
        
        #searchBtn {
          padding: 14px;
          justify-content: center;
        }
        
        .control-btn {
          font-size: 1rem;
          width: 36px;
          height: 36px;
        }
        
        .speed-control {
          padding: 6px 12px;
          font-size: 0.85rem;
        }
        
        .volume-slider-container {
          display: none;
        }
        
        .loop-indicator {
          bottom: 50px;
          left: 10px;
          font-size: 0.8rem;
          padding: 4px 8px;
        }
        
        .tooltip {
          font-size: 0.7rem;
          top: -30px;
          padding: 4px 8px;
        }
      }

      .footer {
        margin-top: 30px;
        text-align: center;
        color: #9ca3af;
        font-size: 0.9rem;
        width: 100%;
        padding: 20px;
        border-top: 2px solid #f0ece4; /* Beige border */
      }

      .save-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: #6b5d51; /* Darker beige */
        padding: 15px 30px;
        border-radius: 25px;
        z-index: 3000;
        box-shadow: 0 5px 15px rgba(138, 155, 110, 0.2); /* Updated shadow */
        border: 2px solid #f0ece4; /* Beige border */
        animation: fadeInOut 3s forwards;
        display: none;
        font-weight: 500;
      }

      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        20% { opacity: 1; transform: translateX(-50%) translateY(0); }
        80% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      }

      /* Cute loading animation */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        color: #8a9b6e; /* Desaturated green */
        font-weight: 500;
      }

      .loading i {
        margin-right: 10px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .no-results, .error-message {
        padding: 30px;
        text-align: center;
        color: #8a9b6e; /* Using your desaturated green */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .no-results i, .error-message i {
        font-size: 2rem;
        color: inherit;
      }
  </style>
</head>
<body>
  <!-- STARTUP LOADING SCREEN -->
  <div class="startup-loading" id="startupLoading">
    <img src="../assets/stepwise-icon.png" alt="Dancing figure" class="startup-logo">
    <h1 class="startup-title">Stepwise Studio</h1>
    <p class="startup-tagline">Precision • Dance • Control</p>
    <div class="startup-spinner"></div>
    <p class="startup-status">Loading dance magic<span class="loading-dots"><span></span><span></span><span></span></span></p>
  </div>

  <div class="header">
    <img src="../assets/stepwise-icon.png" alt="Dancing figure icon" class="header-icon">
    <div class="header-content">
      <h1>Stepwise Studio</h1>
      <p class="tagline">Precision • Dance • Control</p>
    </div>
  </div>
    
  <div class="container">
    <section class="search-section">
      <div class="search-container">
        <input type="text" id="searchQuery" placeholder="Search YouTube for dance tutorials...">
        <button id="searchBtn">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
      <div id="results"></div>
    </section>
    
    <div class="player-container">
      <section class="player-section">
        <div class="video-container">
          <!-- VIDEO DOWNLOAD LOADING OVERLAY -->
          <div class="video-loading-overlay" id="videoLoadingOverlay">
            <img src="../assets/stepwise-icon.png" alt="Dancing figure" class="download-dancer">
            <h3 class="download-title">Loading Video</h3>
            <p class="download-subtitle">Preparing your dance tutorial<span class="loading-dots"><span></span><span></span><span></span></span></p>
            
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="downloadProgress"></div>
              </div>
              <div class="progress-text" id="progressText">0%</div>
            </div>
            
            <p class="download-tips">This may take a moment depending on video quality and your internet connection</p>
          </div>

          <div id="videoTitle"></div>
          <video id="videoPlayer" preload="metadata"></video>
          
          <div class="pause-animation" id="pauseAnimation">
            <i class="fas fa-pause" id="pauseIcon"></i>
          </div>
          
          <div class="skip-animation" id="skipAnimation">
            <div class="skip-animation-circle"></div>
            <div class="skip-animation-icon">
              <i id="skipIcon"></i>
            </div>
          </div>
          
          <div class="loop-highlight" id="loopHighlight"></div>
          
          <div class="loop-indicator" id="loopIndicator">
            <i class="fas fa-repeat"></i> Looping: <span id="loopStartLabel">0:00</span> - <span id="loopEndLabel">0:10</span>
          </div>
          
          <div class="controls-overlay">
            <!-- NEW: Progress container with handles moved outside -->
            <div class="progress-container">
              <div class="playback-bar">
                <div class="loop-range" id="loopRange"></div>
                <div class="playback-progress" id="playbackProgress">
                  <div class="playback-thumb" id="playbackThumb"></div>
                </div>
              </div>
              <div class="loop-handle start" id="loopStartHandle">
                <span class="tooltip">Loop Start</span>
              </div>
              <div class="loop-handle end" id="loopEndHandle">
                <span class="tooltip">Loop End</span>
              </div>
            </div>
            
            <div class="controls-bar">
              <div class="control-btn-container" id="playPauseBtn-container">
                <button id="playPauseBtn" class="control-btn">
                  <i class="fas fa-play" id="playIcon"></i>
                </button>
                <span class="tooltip">Play/Pause (Space)</span>
              </div>
              
              <div class="control-btn-container">
                <button id="skipBackBtn" class="control-btn">
                  <i class="fas fa-step-backward"></i>
                </button>
                <span class="tooltip">Skip Back 5s (←)</span>
              </div>
              
              <div class="time-display">
                <span id="currentTimeLabel">0:00</span> / 
                <span id="durationLabel">0:00</span>
              </div>
              
              <div class="control-btn-container">
                <button id="skipForwardBtn" class="control-btn">
                  <i class="fas fa-step-forward"></i>
                </button>
                <span class="tooltip">Skip Forward 5s (→)</span>
              </div>
              
              <div class="volume-control">
                <div class="control-btn-container">
                  <button id="volumeBtn" class="control-btn">
                    <i class="fas fa-volume-up" id="volumeIcon"></i>
                  </button>
                  <span class="tooltip">Volume</span>
                </div>
                <div class="volume-slider-container">
                  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
                </div>
              </div>
              
              <div class="controls-spacer"></div>
              
              <div class="control-btn-container">
                <button id="saveBtn" class="control-btn">
                  <i class="far fa-bookmark" id="saveIcon"></i>
                </button>
                <span class="tooltip">Save Video</span>
              </div>
              
              <div class="control-btn-container">
                <button id="loopBtn" class="control-btn">
                  <i class="fas fa-repeat"></i>
                </button>
                <span class="tooltip">Loop (L)</span>
              </div>
              
              <div class="control-btn-container">
                <button id="speedBtn" class="speed-control">
                  1x
                </button>
                <span class="tooltip">Playback Speed</span>
              </div>
              
              <div class="control-btn-container">
                <button id="mirrorBtn" class="control-btn">
                  <i class="fas fa-arrows-left-right"></i>
                </button>
                <span class="tooltip">Mirror (M)</span>
              </div>
              
              <div class="control-btn-container" id="fullscreenBtn-container">
                <button id="fullscreenBtn" class="control-btn">
                  <i class="fas fa-expand"></i>
                </button>
                <span class="tooltip">Fullscreen (F)</span>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <section class="saved-section">
        <div class="saved-header">
          <h2 class="saved-title">Saved Videos</h2>
          <button class="clear-saved" id="clearSaved">
            <i class="fas fa-trash-alt clear-all-icon"></i> Clear
          </button>
        </div>
        <div class="saved-videos-container" id="savedVideosContainer">
          <div class="empty-saved">
            <i class="fas fa-bookmark"></i>
            <p>No saved videos yet</p>
            <p>Save videos to watch later</p>
          </div>
        </div>
      </section>
    </div>
  </div>
  
  <div class="footer">
    <p>Stepwise Studio &copy; 2025 | Master dance moves with precision</p>
  </div>
  
  <div class="save-notification" id="saveNotification">Video saved!</div>

  <script>
    // Check if we're running in Electron
    const isElectronApp = !!(window.electronAPI && window.electronAPI.getAppVersion);

    if (!isElectronApp) {
      console.error('This application requires Electron to run');
      alert('This application must be run through Electron');
    }

    // STARTUP LOADING SCREEN MANAGEMENT
    const startupLoading = document.getElementById('startupLoading');

    // Simulate startup loading process
    function initializeApp() {
      const loadingStatuses = [
        'Loading dance magic...',
        'Initializing video player...',
        'Connecting to YouTube...',
        'Preparing workspace...',
        'Almost ready...'
      ];

      let currentStatus = 0;
      const statusElement = startupLoading.querySelector('.startup-status');

      const updateStatus = () => {
        if (currentStatus < loadingStatuses.length) {
          statusElement.innerHTML = loadingStatuses[currentStatus] + '<span class="loading-dots"><span></span><span></span><span></span></span>';
          currentStatus++;
          setTimeout(updateStatus, 800);
        } else {
          // Hide startup screen
          setTimeout(() => {
            startupLoading.classList.add('hidden');
            setTimeout(() => {
              startupLoading.style.display = 'none';
            }, 800);
          }, 500);
        }
      };

      // Start the loading sequence
      setTimeout(updateStatus, 1000);
    }

    // Set app version in footer
    if (window.electronAPI) {
      window.electronAPI.getAppVersion().then(version => {
        const footer = document.querySelector('.footer p');
        if (footer) {
          footer.textContent = `Stepwise Studio v${version} | Master dance moves with precision`;
        }
      });
    }

    // Cookie utility functions (same as before)
    function setCookie(name, value, days = 30) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${JSON.stringify(value)};expires=${expires.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) {
          try {
            return JSON.parse(c.substring(nameEQ.length, c.length));
          } catch (e) {
            return null;
          }
        }
      }
      return null;
    }

    // DOM Elements (same as before)
    const searchBtn = document.getElementById('searchBtn');
    const searchQuery = document.getElementById('searchQuery');
    const resultsDiv = document.getElementById('results');
    const video = document.getElementById('videoPlayer');
    const videoTitle = document.getElementById('videoTitle');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const speedBtn = document.getElementById('speedBtn');
    const loopBtn = document.getElementById('loopBtn');
    const mirrorBtn = document.getElementById('mirrorBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const skipBackBtn = document.getElementById('skipBackBtn');
    const skipForwardBtn = document.getElementById('skipForwardBtn');
    const loopRange = document.getElementById('loopRange');
    const loopStartHandle = document.getElementById('loopStartHandle');
    const loopEndHandle = document.getElementById('loopEndHandle');
    const pauseAnimation = document.getElementById('pauseAnimation');
    const skipAnimation = document.getElementById('skipAnimation');
    const skipIcon = document.getElementById('skipIcon');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const loopIndicator = document.getElementById('loopIndicator');
    const loopStartLabel = document.getElementById('loopStartLabel');
    const loopEndLabel = document.getElementById('loopEndLabel');
    const loopHighlight = document.getElementById('loopHighlight');
    const saveBtn = document.getElementById('saveBtn');
    const saveIcon = document.getElementById('saveIcon');
    const savedVideosContainer = document.getElementById('savedVideosContainer');
    const clearSavedBtn = document.getElementById('clearSaved');
    const saveNotification = document.getElementById('saveNotification');

    // NEW: Video loading overlay elements
    const videoLoadingOverlay = document.getElementById('videoLoadingOverlay');
    const downloadProgress = document.getElementById('downloadProgress');
    const progressText = document.getElementById('progressText');

    // Playback bar elements
    const progressContainer = document.querySelector('.progress-container');
    const playbackBar = document.querySelector('.playback-bar');
    const playbackProgress = document.getElementById('playbackProgress');
    const currentTimeLabel = document.getElementById('currentTimeLabel');
    const durationLabel = document.getElementById('durationLabel');

    // Variables (same as before)
    let loopAnimationFrame = null;
    let lastVideoTitle = '';
    let lastVideoId = '';
    let lastThumbnail = '';
    let isSeeking = false;
    let isLoopMode = false;
    let loopStartTime = 0;
    let loopEndTime = 10;
    let isDraggingLoopHandle = false;
    let currentDragHandle = null;
    let isFullscreen = false;
    let savedVideos = getCookie('savedVideos') || [];

    // Speed control
    const speeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2];
    let currentSpeedIndex = 3; // 1x is default

    // ENHANCED DOWNLOAD PROGRESS SIMULATION
    function simulateDownloadProgress() {
      let progress = 0;
      isVideoActuallyLoaded = false;
      
      // Clear any existing simulation
      if (progressSimulation) {
        clearInterval(progressSimulation);
      }
      
      progressSimulation = setInterval(() => {
        if (progress < 75) {
          // Fast initial progress for first 30%
          if (progress < 30) {
            progress += Math.random() * 8 + 5;
          }
          // Slower progress from 30% to 75%
          else {
            progress += Math.random() * 3 + 1;
          }
        } else if (progress < 91 && !isVideoActuallyLoaded) {
          // Very slow progress from 75% to 91% while waiting for actual video
          progress += Math.random() * 0.5 + 0.2;
        } else if (isVideoActuallyLoaded) {
          // Complete quickly once video is actually loaded
          progress = Math.min(100, progress + 10);
          if (progress >= 100) {
            clearInterval(progressSimulation);
            progressText.textContent = 'Complete!';
            setTimeout(() => {
              hideVideoLoadingOverlay();
            }, 500);
            return;
          }
        }
        
        progress = Math.min(91, progress); // Cap at 95% until video loads
        downloadProgress.style.width = progress + '%';
        progressText.textContent = Math.floor(progress) + '%';
      }, 200);
    }

    function showVideoLoadingOverlay() {
      videoLoadingOverlay.classList.add('visible');
      downloadProgress.style.width = '0%';
      progressText.textContent = '0%';
    }

    function hideVideoLoadingOverlay() {
      videoLoadingOverlay.classList.remove('visible');
    }

    // Initialize
    loadUserPreferences();
    updateSavedVideos();
    initializeApp(); // Start the startup loading sequence

    // All the utility functions (same as before)
    function saveUserPreferences() {
      const preferences = {
        volume: video.volume,
        playbackRate: video.playbackRate,
        loopMode: isLoopMode,
        loopStartTime: loopStartTime,
        loopEndTime: loopEndTime,
        mirrorMode: video.classList.contains('mirror-video'),
        lastSearchQuery: searchQuery.value
      };
      setCookie('stepwisePreferences', preferences);
    }

    function loadUserPreferences() {
      const preferences = getCookie('stepwisePreferences');
      if (preferences) {
        if (preferences.volume !== undefined) {
          video.volume = preferences.volume;
          volumeSlider.value = preferences.volume;
          updateVolumeIcon();
        }
        
        if (preferences.playbackRate !== undefined) {
          video.playbackRate = preferences.playbackRate;
          const speedIndex = speeds.indexOf(preferences.playbackRate);
          if (speedIndex !== -1) {
            currentSpeedIndex = speedIndex;
            speedBtn.textContent = `${preferences.playbackRate}x`;
          }
        }
        
        if (preferences.loopMode !== undefined) {
          isLoopMode = preferences.loopMode;
          if (preferences.loopStartTime !== undefined) loopStartTime = preferences.loopStartTime;
          if (preferences.loopEndTime !== undefined) loopEndTime = preferences.loopEndTime;
          
          if (isLoopMode) {
            loopBtn.classList.add('active');
            loopRange.style.display = 'block';
            loopStartHandle.style.display = 'block';
            loopEndHandle.style.display = 'block';
            loopIndicator.style.display = 'block';
            loopHighlight.classList.add('active');
          }
        }
        
        if (preferences.mirrorMode) {
          video.classList.add('mirror-video');
          mirrorBtn.classList.add('active');
        }
        
        if (preferences.lastSearchQuery) {
          searchQuery.value = preferences.lastSearchQuery;
        }
      }
    }

    // Search YouTube videos - SIMPLIFIED FOR ELECTRON ONLY
    async function searchYouTube() {
      const query = searchQuery.value.trim();
      if (!query) return alert('Please enter a search term.');
      
      resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-heart"></i>Searching for dance tutorials...</div>';
      
      // Save search query to preferences
      saveUserPreferences();
      
      try {
        // Use Electron IPC for search
        const data = await window.electronAPI.youtubeSearch(query);
        
        if (!data.items || data.items.length === 0) {
          resultsDiv.innerHTML = `
            <div class="no-results">
              <i class="fas fa-heart-broken"></i>
              <p>No dance videos found. Try another search term!</p>
            </div>
          `;
          return;
        }
        
        resultsDiv.innerHTML = '';
        
        data.items.forEach(item => {
          const videoId = item.id.videoId;
          const title = item.snippet.title;
          const thumbnail = item.snippet.thumbnails.medium.url;
          const isSaved = savedVideos.some(video => video.id === videoId);
          
          const div = document.createElement('div');
          div.className = 'video-item';
          div.innerHTML = `
            <img src="${thumbnail}" alt="${title}" loading="lazy">
            <strong>${title}</strong>
            <button class="save-btn ${isSaved ? 'saved' : ''}" data-id="${videoId}" aria-label="${isSaved ? 'Unsave' : 'Save'} this video">
              <i class="${isSaved ? 'fas' : 'far'} fa-bookmark"></i>
            </button>
          `;
          
          div.onclick = () => {
            lastVideoTitle = title;
            lastVideoId = videoId;
            lastThumbnail = thumbnail;
            downloadAndPlay(videoId);
          };
          
          const saveBtn = div.querySelector('.save-btn');
          saveBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (isSaved) {
              removeSavedVideo(videoId);
              saveBtn.classList.remove('saved');
              saveBtn.innerHTML = '<i class="far fa-bookmark"></i>';
              saveBtn.setAttribute('aria-label', 'Save this video');
            } else {
              saveVideo(videoId, title, thumbnail);
              saveBtn.classList.add('saved');
              saveBtn.innerHTML = '<i class="fas fa-bookmark"></i>';
              saveBtn.setAttribute('aria-label', 'Unsave this video');
            }
          });
          
          resultsDiv.appendChild(div);
        });
        
      } catch (err) {
        console.error('Search error:', err);
        window.electronAPI.showMessageBox({
          type: 'error',
          title: 'Search Error',
          message: 'Failed to search YouTube',
          detail: err.message
        });
        resultsDiv.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error searching videos. Please try again!</p>
            <p style="font-size: 0.8em; color: #666;">${err.message}</p>
          </div>
        `;
      }
    }

    // Download and play video - ENHANCED WITH LOADING OVERLAY
    async function downloadAndPlay(videoId) {
      // Clear search results
      resultsDiv.innerHTML = '';
      
      // Show video loading overlay
      showVideoLoadingOverlay();
      
      // Start progress simulation
      simulateDownloadProgress(4000); // 4 second simulation
      
      try {
        // Reset controls when new video is selected
        resetControls();
        
        // Set video title (clean up title)
        const cleanTitle = lastVideoTitle.replace(/[^\w\s-]/gi, '');
        videoTitle.textContent = cleanTitle || 'Dance Tutorial';
        videoTitle.style.display = 'block';
        
        // Use Electron IPC for download
        const data = await window.electronAPI.downloadVideo(videoId);
        
        if (!data.url) throw new Error('No video URL returned');
        
        // Set video source
        video.src = data.url;
        video.load();
        
        video.oncanplay = async () => {
          try {
            const playPromise = video.play();
            
            if (playPromise !== undefined) {
              await playPromise;
              playIcon.className = 'fas fa-pause';
            }
          } catch (err) {
            console.warn('Playback prevented:', err);
            playIcon.className = 'fas fa-play';
          }
        };
      } catch (err) {
        console.error('Download/playback error:', err);
        hideVideoLoadingOverlay();
        window.electronAPI.showMessageBox({
          type: 'error',
          title: 'Playback Error',
          message: 'Error playing video',
          detail: err.message
        });
        videoTitle.style.display = 'none';
      }
    }

    // Update volume icon based on current volume
    function updateVolumeIcon() {
      if (video.volume === 0) {
        volumeIcon.className = 'fas fa-volume-mute';
      } else if (video.volume < 0.5) {
        volumeIcon.className = 'fas fa-volume-down';
      } else {
        volumeIcon.className = 'fas fa-volume-up';
      }
    }

    // Save current video
    saveBtn.addEventListener('click', () => {
      if (!lastVideoId) return;
      
      const isSaved = savedVideos.some(video => video.id === lastVideoId);
      
      if (!isSaved) {
        savedVideos.push({
          id: lastVideoId,
          title: lastVideoTitle,
          thumbnail: lastThumbnail,
          savedAt: new Date().toISOString()
        });
        
        setCookie('savedVideos', savedVideos);
        updateSavedVideos();
        
        saveNotification.textContent = 'Video saved!';
        saveNotification.style.display = 'block';
        setTimeout(() => {
          saveNotification.style.display = 'none';
        }, 3000);
        
        saveIcon.className = 'fas fa-bookmark';
      }
    });

    // Clear all saved videos
    clearSavedBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all saved videos?')) {
        savedVideos = [];
        setCookie('savedVideos', savedVideos);
        updateSavedVideos();
        
        saveNotification.textContent = 'All videos cleared!';
        saveNotification.style.display = 'block';
        setTimeout(() => {
          saveNotification.style.display = 'none';
        }, 3000);
      }
    });

    // Update saved videos display
    function updateSavedVideos() {
      savedVideosContainer.innerHTML = '';
      
      if (savedVideos.length === 0) {
        savedVideosContainer.innerHTML = `
          <div class="empty-saved">
            <i class="fas fa-bookmark"></i>
            <p>No saved videos yet</p>
            <p>Save videos to watch later</p>
          </div>
        `;
        return;
      }
      
      const sortedVideos = [...savedVideos].sort((a, b) => 
        new Date(b.savedAt || 0) - new Date(a.savedAt || 0)
      );
      
      sortedVideos.forEach(video => {
        const videoElement = document.createElement('div');
        videoElement.className = 'saved-video';
        videoElement.innerHTML = `
          <img src="${video.thumbnail}" alt="${video.title}" class="saved-thumb">
          <div class="saved-details">
            <div class="saved-video-title">${video.title}</div>
          </div>
          <div class="saved-actions">
            <button class="saved-btn play-saved" data-id="${video.id}" title="Play Video">
              <i class="fas fa-play"></i>
            </button>
            <button class="saved-btn remove-saved" data-id="${video.id}" title="Remove from Saved">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        savedVideosContainer.appendChild(videoElement);
      });
      
      // Add event listeners
      document.querySelectorAll('.play-saved').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const videoId = btn.getAttribute('data-id');
          const video = savedVideos.find(v => v.id === videoId);
          if (video) {
            lastVideoTitle = video.title;
            lastVideoId = video.id;
            lastThumbnail = video.thumbnail;
            downloadAndPlay(videoId);
          }
        });
      });
      
      document.querySelectorAll('.remove-saved').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const videoId = btn.getAttribute('data-id');
          removeSavedVideo(videoId);
        });
      });
    }

    // Save video function
    function saveVideo(videoId, title, thumbnail) {
      const isSaved = savedVideos.some(video => video.id === videoId);
      
      if (!isSaved) {
        savedVideos.push({
          id: videoId,
          title: title,
          thumbnail: thumbnail,
          savedAt: new Date().toISOString()
        });
        
        setCookie('savedVideos', savedVideos);
        updateSavedVideos();
        
        saveNotification.textContent = 'Video saved!';
        saveNotification.style.display = 'block';
        setTimeout(() => {
          saveNotification.style.display = 'none';
        }, 3000);
      }
    }

    // Remove saved video
    function removeSavedVideo(videoId) {
      savedVideos = savedVideos.filter(video => video.id !== videoId);
      setCookie('savedVideos', savedVideos);
      updateSavedVideos();
      
      saveNotification.textContent = 'Video removed!';
      saveNotification.style.display = 'block';
      setTimeout(() => {
        saveNotification.style.display = 'none';
      }, 3000);
    }

    // YouTube-like keyboard controls
    document.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
      
      switch(e.key) {
        case ' ':
          e.preventDefault();
          togglePlayPause();
          showPauseAnimation();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          skipVideo(-5);
          break;
        case 'ArrowRight':
          e.preventDefault();
          skipVideo(5);
          break;
        case 'f':
        case 'F':
          e.preventDefault();
          toggleFullscreen();
          break;
        case 'm':
        case 'M':
          e.preventDefault();
          toggleMirror();
          break;
        case 'l':
        case 'L':
          e.preventDefault();
          toggleLoopMode();
          break;
      }
    });

    // Reset all controls to default
    function resetControls() {
      video.playbackRate = 1;
      speedBtn.textContent = '1x';
      
      video.classList.remove('mirror-video');
      mirrorBtn.classList.remove('active');
      
      isLoopMode = false;
      loopBtn.classList.remove('active');
      loopRange.style.display = 'none';
      loopStartHandle.style.display = 'none';
      loopEndHandle.style.display = 'none';
      loopIndicator.style.display = 'none';
      loopHighlight.classList.remove('active');
      stopLoop();
      
      video.volume = 1;
      volumeSlider.value = 1;
      updateVolumeIcon();
      
      currentTimeLabel.textContent = '0:00';
      durationLabel.textContent = '0:00';
      
      playbackProgress.style.width = '0%';
      
      saveIcon.className = 'far fa-bookmark';
      
      setTimeout(() => {
        loadUserPreferences();
      }, 100);
    }

    // Play/Pause toggle
    function togglePlayPause() {
      if (video.paused) {
        video.play();
        playIcon.className = 'fas fa-pause';
      } else {
        video.pause();
        playIcon.className = 'fas fa-play';
      }
    }

    // YouTube-like skip animation
    function skipVideo(seconds) {
      const oldTime = video.currentTime;
      video.currentTime = Math.max(0, Math.min(video.duration, oldTime + seconds));
      
      skipIcon.className = seconds > 0 ? 'fas fa-forward' : 'fas fa-backward';
      
      const rect = playbackBar.getBoundingClientRect();
      const percent = (oldTime / video.duration) * 100;
      skipAnimation.style.left = `${(percent / 100) * rect.width}px`;
      
      skipAnimation.style.display = 'flex';
      skipAnimation.classList.add('visible');
      
      setTimeout(() => {
        skipAnimation.classList.remove('visible');
        setTimeout(() => {
          skipAnimation.style.display = 'none';
        }, 300);
      }, 800);
    }

    // Toggle mirror
    function toggleMirror() {
      video.classList.toggle('mirror-video');
      mirrorBtn.classList.toggle('active');
      saveUserPreferences();
    }

    // Toggle fullscreen
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(console.log);
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        document.body.classList.add('fullscreen');
        isFullscreen = true;
      } else {
        document.exitFullscreen();
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        document.body.classList.remove('fullscreen');
        isFullscreen = false;
      }
    }

    // Fullscreen change handler
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        document.body.classList.remove('fullscreen');
        isFullscreen = false;
      }
    });

    // Toggle loop mode
    function toggleLoopMode() {
      isLoopMode = !isLoopMode;
      loopBtn.classList.toggle('active', isLoopMode);
      loopRange.style.display = isLoopMode ? 'block' : 'none';
      loopStartHandle.style.display = isLoopMode ? 'block' : 'none';
      loopEndHandle.style.display = isLoopMode ? 'block' : 'none';
      loopIndicator.style.display = isLoopMode ? 'block' : 'none';
      loopHighlight.classList.toggle('active', isLoopMode);
      
      if (isLoopMode) {
        loopStartTime = video.currentTime;
        loopEndTime = Math.min(video.duration, video.currentTime + 10);
        updateLoopRangeDisplay();
        updateLoopIndicator();
        startLoop();
      } else {
        stopLoop();
      }
      
      saveUserPreferences();
    }

    // Start seamless loop
    function startLoop() {
      stopLoop();
      
      loopStartTime = Math.max(0, loopStartTime);
      loopEndTime = Math.min(video.duration || 10, loopEndTime);
      
      if (loopStartTime >= loopEndTime) {
        window.electronAPI.showMessageBox({
          type: 'warning',
          title: 'Invalid Loop',
          message: 'Loop start must be less than loop end'
        });
        return;
      }
      
      function seamlessLoop() {
        if (!isLoopMode) return;
        
        const currentTime = video.currentTime;
        const buffer = 0.05;
        
        if (currentTime >= loopEndTime - buffer) {
          const bufferProgress = (currentTime - (loopEndTime - buffer)) / buffer;
          video.currentTime = loopStartTime + (bufferProgress * buffer);
        }
        
        loopAnimationFrame = requestAnimationFrame(seamlessLoop);
      }
      
      loopAnimationFrame = requestAnimationFrame(seamlessLoop);
    }

    // Stop loop
    function stopLoop() {
      if (loopAnimationFrame) {
        cancelAnimationFrame(loopAnimationFrame);
        loopAnimationFrame = null;
      }
    }

    // Update loop range display
    function updateLoopRangeDisplay() {
      if (video.duration) {
        const startPercent = Math.max(0, (loopStartTime / video.duration) * 100);
        const endPercent = Math.min(100, (loopEndTime / video.duration) * 100);
        
        loopRange.style.left = `${startPercent}%`;
        loopRange.style.width = `${Math.max(0, endPercent - startPercent)}%`;
        
        loopStartHandle.style.left = `${startPercent-100}%`;
        loopEndHandle.style.left = `${endPercent-100}%`;
        
        loopStartHandle.style.display = 'block';
        loopEndHandle.style.display = 'block';
      }
    }

    // Update loop indicator
    function updateLoopIndicator() {
      loopStartLabel.textContent = formatTime(loopStartTime);
      loopEndLabel.textContent = formatTime(loopEndTime);
    }

    // Show pause animation
    function showPauseAnimation() {
      pauseIcon.className = video.paused ? 'fas fa-play' : 'fas fa-pause';
      pauseAnimation.classList.add('visible');
      setTimeout(() => {
        pauseAnimation.classList.remove('visible');
      }, 500);
    }

    // Event listeners
    playPauseBtn.addEventListener('click', () => {
      togglePlayPause();
      showPauseAnimation();
    });

    video.addEventListener('play', () => playIcon.className = 'fas fa-pause');
    video.addEventListener('pause', () => playIcon.className = 'fas fa-play');

    video.addEventListener('click', () => {
      togglePlayPause();
      showPauseAnimation();
    });

    speedBtn.addEventListener('click', () => {
      currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
      const speed = speeds[currentSpeedIndex];
      video.playbackRate = speed;
      speedBtn.textContent = `${speed}x`;
      saveUserPreferences();
    });

    loopBtn.addEventListener('click', toggleLoopMode);
    mirrorBtn.addEventListener('click', toggleMirror);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    skipBackBtn.addEventListener('click', () => skipVideo(-5));
    skipForwardBtn.addEventListener('click', () => skipVideo(5));
    searchBtn.addEventListener('click', searchYouTube);
    searchQuery.addEventListener('keypress', (e) => e.key === 'Enter' && searchYouTube());

    // Volume control
    volumeSlider.addEventListener('input', () => {
      video.volume = volumeSlider.value;
      updateVolumeIcon();
      saveUserPreferences();
    });

    volumeBtn.addEventListener('click', () => {
      if (video.volume > 0) {
        video.volume = 0;
        volumeSlider.value = 0;
      } else {
        video.volume = 1;
        volumeSlider.value = 1;
      }
      updateVolumeIcon();
      saveUserPreferences();
    });

    // Save preferences when search query changes
    searchQuery.addEventListener('input', () => {
      saveUserPreferences();
    });

    // Playback bar functionality
    video.addEventListener('loadedmetadata', () => {
      durationLabel.textContent = formatTime(video.duration);
      loopStartTime = 0;
      loopEndTime = Math.min(video.duration * 0.95, 10);

      markVideoAsLoaded();
      
      if (isLoopMode) {
        updateLoopRangeDisplay();
        updateLoopIndicator();
        startLoop();
      }
    });

    video.addEventListener('timeupdate', () => {
      currentTimeLabel.textContent = formatTime(video.currentTime);
      const percent = video.duration ? (video.currentTime / video.duration) * 100 : 0;
      playbackProgress.style.width = percent + '%';
    });

    // Progress bar click for seeking
    progressContainer.addEventListener('mousedown', (e) => {
      if (isDraggingLoopHandle) return;
      
      const rect = playbackBar.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const percent = Math.max(0, Math.min(1, x / rect.width));
      const seekTime = percent * video.duration;
      
      if (isLoopMode && seekTime > loopEndTime) {
        video.currentTime = loopStartTime;
        if (video.paused) {
          video.play();
          playIcon.className = 'fas fa-pause';
        }
        return;
      }
      
      video.currentTime = seekTime;
    });

    // Loop handles dragging
    loopStartHandle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      isDraggingLoopHandle = true;
      currentDragHandle = 'start';
      
      if (!isLoopMode) {
        toggleLoopMode();
      }
      
      document.addEventListener('mousemove', dragLoopHandle);
      document.addEventListener('mouseup', stopDragLoopHandle);
    });

    loopEndHandle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      isDraggingLoopHandle = true;
      currentDragHandle = 'end';
      
      if (!isLoopMode) {
        toggleLoopMode();
      }
      
      document.addEventListener('mousemove', dragLoopHandle);
      document.addEventListener('mouseup', stopDragLoopHandle);
    });

    function dragLoopHandle(e) {
      if (!isDraggingLoopHandle || !video.duration) return;
      
      const rect = playbackBar.getBoundingClientRect();
      const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
      const percent = (x / rect.width) * 100;
      const time = (percent / 100) * video.duration;
      
      if (currentDragHandle === 'start') {
        loopStartTime = Math.max(0, Math.min(loopEndTime - 0.1, time));
        video.currentTime = loopStartTime;
      } else {
        loopEndTime = Math.min(video.duration, Math.max(loopStartTime + 0.1, time));
      }
      
      updateLoopRangeDisplay();
      updateLoopIndicator();
      saveUserPreferences();
      
      if (isLoopMode) {
        startLoop();
      }
    }

    function stopDragLoopHandle() {
      isDraggingLoopHandle = false;
      document.removeEventListener('mousemove', dragLoopHandle);
      document.removeEventListener('mouseup', stopDragLoopHandle);
    }

    // Format time as mm:ss
    function formatTime(sec) {
      if (!isFinite(sec)) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // Auto-save preferences
    video.addEventListener('volumechange', saveUserPreferences);
    video.addEventListener('ratechange', saveUserPreferences);

    // Welcome message for first-time users
    if (!getCookie('stepwiseWelcome')) {
      setTimeout(() => {
        saveNotification.textContent = 'Welcome to Stepwise Studio! Search for dance tutorials to get started.';
        saveNotification.style.display = 'block';
        setTimeout(() => {
          saveNotification.style.display = 'none';
        }, 5000);
        setCookie('stepwiseWelcome', true);
      }, 7000); // Show after startup loading is complete
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      saveUserPreferences();
    });

    // Enhanced state management
    class AppStateManager {
      constructor() {
        this.state = {
          // Video player state
          currentVideoId: null,
          currentVideoTitle: '',
          currentThumbnail: '',
          currentTime: 0,
          isPlaying: false,
          
          // Player settings
          volume: 1,
          playbackRate: 1,
          loopMode: false,
          loopStartTime: 0,
          loopEndTime: 10,
          mirrorMode: false,
          
          // UI state
          savedVideos: [],
          recentVideos: [],
          lastSearchQuery: '',
          
          // Session data
          sessionStartTime: Date.now(),
          practiceTime: 0
        };
        
        this.autoSaveInterval = null;
        this.isInitialized = false;
      }

      // Initialize and load saved state
      async initialize() {
        if (this.isInitialized) return;
        
        try {
          console.log('🔄 Loading saved app state...');
          
          // Load all preferences from Electron
          const savedState = await window.electronAPI.getPreferences();
          
          // Merge with current state
          this.state = { ...this.state, ...savedState };
          
          // Apply loaded state to UI
          this.applyStateToUI();
          
          // Set up auto-save
          this.setupAutoSave();
          
          // Listen for app events
          this.setupEventListeners();
          
          this.isInitialized = true;
          console.log('✅ App state loaded and initialized');
          
        } catch (error) {
          console.warn('⚠️ Could not load saved state:', error);
        }
      }

      // Apply loaded state to the UI
      applyStateToUI() {
        // Restore video player settings
        if (video) {
          video.volume = this.state.volume || 1;
          video.playbackRate = this.state.playbackRate || 1;
          
          if (volumeSlider) volumeSlider.value = this.state.volume || 1;
          if (speedBtn) speedBtn.textContent = `${this.state.playbackRate || 1}x`;
          
          updateVolumeIcon();
        }

        // Restore loop settings
        if (this.state.loopMode) {
          isLoopMode = true;
          loopStartTime = this.state.loopStartTime || 0;
          loopEndTime = this.state.loopEndTime || 10;
          
          if (loopBtn) loopBtn.classList.add('active');
          if (loopRange) loopRange.style.display = 'block';
          if (loopStartHandle) loopStartHandle.style.display = 'block';
          if (loopEndHandle) loopEndHandle.style.display = 'block';
          if (loopIndicator) loopIndicator.style.display = 'block';
          if (loopHighlight) loopHighlight.classList.add('active');
        }

        // Restore mirror mode
        if (this.state.mirrorMode) {
          if (video) video.classList.add('mirror-video');
          if (mirrorBtn) mirrorBtn.classList.add('active');
        }

        // Restore search query
        if (this.state.lastSearchQuery && searchQuery) {
          searchQuery.value = this.state.lastSearchQuery;
        }

        // Restore saved videos
        if (this.state.savedVideos) {
          savedVideos = this.state.savedVideos;
          updateSavedVideos();
        }

        // Restore last video if available
        if (this.state.currentVideoId && this.state.currentVideoId !== 'null') {
          this.restoreLastVideo();
        }

        console.log('🎨 UI state restored');
      }

      // Restore the last video that was playing
      async restoreLastVideo() {
        try {
          console.log('🎬 Restoring last video:', this.state.currentVideoId);
          
          lastVideoId = this.state.currentVideoId;
          lastVideoTitle = this.state.currentVideoTitle || 'Restored Video';
          lastThumbnail = this.state.currentThumbnail || '';
          
          // Set video title
          if (videoTitle) {
            videoTitle.textContent = lastVideoTitle;
            videoTitle.style.display = 'block';
          }

          // Try to download and load the video
          const data = await window.electronAPI.downloadVideo(lastVideoId);
          if (data.url && video) {
            video.src = data.url;
            video.load();
            
            // Restore playback position after video loads
            video.addEventListener('loadedmetadata', () => {
              if (this.state.currentTime && this.state.currentTime > 0) {
                video.currentTime = Math.min(this.state.currentTime, video.duration);
              }
              
              // Update loop display if in loop mode
              if (isLoopMode) {
                updateLoopRangeDisplay();
                updateLoopIndicator();
              }
            }, { once: true });
          }
        } catch (error) {
          console.warn('⚠️ Could not restore last video:', error.message);
        }
      }

      // Get current app state
      getCurrentState() {
        const currentState = {
          // Video state
          currentVideoId: lastVideoId,
          currentVideoTitle: lastVideoTitle,
          currentThumbnail: lastThumbnail,
          currentTime: video ? video.currentTime : 0,
          isPlaying: video ? !video.paused : false,
          
          // Player settings
          volume: video ? video.volume : 1,
          playbackRate: video ? video.playbackRate : 1,
          loopMode: isLoopMode,
          loopStartTime: loopStartTime,
          loopEndTime: loopEndTime,
          mirrorMode: video ? video.classList.contains('mirror-video') : false,
          
          // UI state
          savedVideos: savedVideos,
          lastSearchQuery: searchQuery ? searchQuery.value : '',
          
          // Session data
          practiceTime: Date.now() - this.state.sessionStartTime
        };

        return currentState;
      }

      // Save current state
      async saveState() {
        try {
          const currentState = this.getCurrentState();
          await window.electronAPI.updatePreferences(currentState);
          console.log('💾 App state saved');
        } catch (error) {
          console.warn('⚠️ Could not save state:', error);
        }
      }

      // Set up auto-save every 30 seconds
      setupAutoSave() {
        // Clear existing interval
        if (this.autoSaveInterval) {
          clearInterval(this.autoSaveInterval);
        }

        // Save state every 30 seconds
        this.autoSaveInterval = setInterval(() => {
          this.saveState();
        }, 30000);

        // Save state when page visibility changes (user switches tabs/minimizes)
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden') {
            this.saveState();
          }
        });

        // Save state before page unload
        window.addEventListener('beforeunload', () => {
          this.saveState();
        });
      }

      // Set up event listeners for Electron IPC
      setupEventListeners() {
        // Listen for auto-save requests from main process
        window.electronAPI.onAutoSave(() => {
          console.log('🔄 Auto-save requested by main process');
          this.saveState();
        });

        // Listen for app closing
        window.electronAPI.onAppClosing(() => {
          console.log('👋 App is closing, saving final state...');
          this.saveState();
        });
      }

      // Clean up
      destroy() {
        if (this.autoSaveInterval) {
          clearInterval(this.autoSaveInterval);
        }
        
        // Remove listeners
        window.electronAPI.removeAllListeners('auto-save-preferences');
        window.electronAPI.removeAllListeners('app-closing');
      }
    }

    // Create global state manager
    const stateManager = new AppStateManager();

    // Initialize when DOM is loaded and startup is complete
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for startup loading to complete before initializing state
      setTimeout(() => {
        if (window.electronAPI) {
          stateManager.initialize();
        } else {
          // Fallback for non-Electron environments
          console.warn('ElectronAPI not available, using localStorage fallback');
          loadUserPreferences(); // Your existing function
        }
      }, 5000); // Wait for startup loading to complete
    });

    // Enhanced save functions that use the state manager
    function saveUserPreferences() {
      if (stateManager.isInitialized) {
        stateManager.saveState();
      } else {
        // Fallback to cookies
        const preferences = {
          volume: video.volume,
          playbackRate: video.playbackRate,
          loopMode: isLoopMode,
          loopStartTime: loopStartTime,
          loopEndTime: loopEndTime,
          mirrorMode: video.classList.contains('mirror-video'),
          lastSearchQuery: searchQuery.value
        };
        setCookie('stepwisePreferences', preferences);
      }
    }

    // Track video changes for state saving
    function trackVideoChange(videoId, title, thumbnail) {
      lastVideoId = videoId;
      lastVideoTitle = title;
      lastThumbnail = thumbnail;
      
      // Save immediately when video changes
      if (stateManager.isInitialized) {
        stateManager.saveState();
      }
    }

    // Modified downloadAndPlay function to track video changes
    const originalDownloadAndPlay = downloadAndPlay;
    downloadAndPlay = async function(videoId) {
      // Track the video change
      trackVideoChange(videoId, lastVideoTitle, lastThumbnail);
      
      // Call original function
      return originalDownloadAndPlay(videoId);
    };

    let progressSimulation = null;
    let isVideoActuallyLoaded = false;
    
    function simulateDownloadProgress() {
      let progress = 0;
      isVideoActuallyLoaded = false;
      
      // Clear any existing simulation
      if (progressSimulation) {
        clearInterval(progressSimulation);
      }
      
      progressSimulation = setInterval(() => {
        if (progress < 75) {
          // Fast initial progress for first 30%
          if (progress < 30) {
            progress += Math.random() * 6 + 5;
          }
          // Slower progress from 30% to 75%
          else {
            progress += Math.random() * 3 + 1;
          }
        } else if (progress < 91 && !isVideoActuallyLoaded) {
          // Very slow progress from 75% to 91% while waiting for actual video
          progress += Math.random() * 0.8 + 0.2;
        } else if (isVideoActuallyLoaded) {
          // Complete quickly once video is actually loaded
          progress = Math.min(100, progress + 10);
          if (progress >= 100) {
            clearInterval(progressSimulation);
            progressText.textContent = 'Complete!';
            setTimeout(() => {
              hideVideoLoadingOverlay();
            }, 300);
            return;
          }
        }
        
        progress = Math.min(91, progress); // Cap at 91% until video loads
        downloadProgress.style.width = progress + '%';
        progressText.textContent = Math.floor(progress) + '%';
      }, 200);
    }
    
    function markVideoAsLoaded() {
      console.log('markVideoAsLoaded called, isVideoActuallyLoaded:', isVideoActuallyLoaded);
      isVideoActuallyLoaded = true;
      
      console.log('Completing progress simulation');
      clearInterval(progressSimulation);
      progressSimulation = null;
      
      downloadProgress.style.width = '100%';
      progressText.textContent = 'Complete!';
      setTimeout(() => {
        hideVideoLoadingOverlay();
      }, 500);
    }

    // Save state when video time updates (throttled)
    let lastTimeSave = 0;
    video.addEventListener('timeupdate', () => {
      const now = Date.now();
      if (now - lastTimeSave > 10000) { // Save every 10 seconds
        lastTimeSave = now;
        if (stateManager.isInitialized) {
          stateManager.saveState();
        }
      }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      stateManager.destroy();
    });

    console.log('💾 Enhanced state management initialized');
    console.log('🎬 Stepwise Studio loaded with enhanced loading screens!');
  </script>
</body>
</html>